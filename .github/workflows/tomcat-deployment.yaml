name: Deploying Springboot Packag(war) to tomcat on Windows Server

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    name: Build Springboot App
    runs-on: ubuntu-18.04
    steps:
      - name: Download the Source Code
        uses: actions/checkout@v3
      
      - name: Setup the Java 17
        uses:  actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Verify the Java Version
        run: java --version

      - name: Make mvnw Exectuable
        run: chmod +x mvnw*

      - name: Build the Application
        run: ./mvnw package
      
      - name: Verify the War file is created or not
        run: ls -l ./target/

      - name: Rename the Long File name to Short File
        run: |
          cd target
          mv CustomerService-0.0.1-SNAPSHOT.war CS.war

      - name: Copy the CS.War file to C:\tomcat\webapps\
        uses: marcodallasanta/ssh-scp-deploy@v1.2.0
        with:
          local: './target/CS.war'
          remote: 'C:\tomcat\webapps\'
          host: ${{secrets.HOST}}
          user: ${{secrets.USER}}
          password: ${{secrets.PASSWORD}}
          ssh_options: -o StrictHostKeyChecking=no
          pre_upload: C:\tomcat\bin\catalina.bat stop && rmdir /s /q CS
          post_upload: C:\tomcat\bin\catalina.bat start